#![cfg_attr(doc, doc = include_str!("../README.md"))]

mod elm;
mod elm_decode;
mod elm_encode;
mod elm_query;
#[cfg(test)]
mod test;

#[cfg(test)]
extern crate self as elm_rs;

pub use self::{
    elm::Elm,
    elm_decode::ElmDecode,
    elm_encode::ElmEncode,
    elm_query::{ElmQuery, ElmQueryField},
};

#[macro_export]
/// Writes an Elm module to the target. Assumes `elm/json` and `elm/http` are installed.
///
/// # Example
/// ```no_run
#[doc = include_str!("../examples/example.rs")]
/// ```
macro_rules! export {
    ($name: expr, $target: expr, {
        $(
            encoders:   [ $($encode: ty),*   $(,)? ] $(,)?
        )?
        $(
            decoders:   [ $($decode: ty),*   $(,)? ] $(,)?
        )?
        $(
            queries:    [ $($query: ty),*    $(,)? ] $(,)?
        )?
        $(
            query_fields:    [ $($query_field: ty),*    $(,)? ] $(,)?
        )?
    }) => {
        {
            fn _export(name: &::std::primitive::str, target: &mut impl ::std::io::Write) -> ::std::result::Result<(), ::std::io::Error> {
                ::std::writeln!(target, r#"
-- generated by elm_rs


module {} exposing (..)

import Dict exposing (Dict)
import Http
import Json.Decode
import Json.Encode
import Url.Builder


{}


{}

"#,
                    name,
                    <::std::result::Result::<(), ()> as $crate::ElmEncode>::encoder_definition().unwrap(),
                    <::std::result::Result::<(), ()> as $crate::ElmDecode>::decoder_definition().unwrap(),
                )?;
                let mut generated_elm_definitions = ::std::collections::HashSet::<&str>::new();
                $($(
                    if !generated_elm_definitions.contains(stringify!($encode)) {
                        generated_elm_definitions.insert(stringify!($encode));
                        if let ::std::option::Option::Some(elm_definition) = <$encode as $crate::Elm>::elm_definition() {
                            ::std::writeln!(target, "{}\n", elm_definition)?;
                        }
                    }
                    if let ::std::option::Option::Some(encoder_definition) = <$encode as $crate::ElmEncode>::encoder_definition() {
                        ::std::writeln!(target, "{}\n", encoder_definition)?;
                    }
                )*)?
                $($(
                    if !generated_elm_definitions.contains(stringify!($decode)) {
                        generated_elm_definitions.insert(stringify!($decode));
                        if let ::std::option::Option::Some(elm_definition) = <$decode as $crate::Elm>::elm_definition() {
                            ::std::writeln!(target, "{}\n", elm_definition)?;
                        }
                    }
                    if let ::std::option::Option::Some(decoder_definition) = <$decode as $crate::ElmDecode>::decoder_definition() {
                        ::std::writeln!(target, "{}\n", decoder_definition)?;
                    }
                )*)?
                $($(
                    if !generated_elm_definitions.contains(stringify!($query)) {
                        generated_elm_definitions.insert(stringify!($query));
                        if let ::std::option::Option::Some(elm_definition) = <$query as $crate::Elm>::elm_definition() {
                            ::std::writeln!(target, "{}\n", elm_definition)?;
                        }
                    }
                    let query_definition = <$query as $crate::ElmQuery>::elm_query();
                    ::std::writeln!(target, "{}\n", query_definition)?;
                )*)?
                $($(
                    if !generated_elm_definitions.contains(stringify!($query_field)) {
                        generated_elm_definitions.insert(stringify!($query_field));
                        if let ::std::option::Option::Some(elm_definition) = <$query_field as $crate::Elm>::elm_definition() {
                            ::std::writeln!(target, "{}\n", elm_definition)?;
                        }
                    }
                    if let Some(query_field_encoder_definition) = <$query_field as $crate::ElmQueryField>::query_field_encoder_definition() {
                        ::std::writeln!(target, "{}\n", query_field_encoder_definition)?;
                    }
                )*)?
                ::std::result::Result::Ok(())
            }
            _export($name, $target)
        }
    };
}
